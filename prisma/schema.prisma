// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 角色定义模型
model Role {
  id        String   @id @default(uuid())
  value     String   @unique  // 角色标识，如 "ADMIN"、"HR"
  label     String            // 角色显示名称，如 "管理员"
  isSystem  Boolean  @default(false) // 系统内置角色，不可删除
  createdAt DateTime @default(now())
}

// 用户模型
model User {
  id             String          @id @default(uuid())
  name           String
  email          String          @unique
  password       String?
  role           String          @default("RECRUITER")
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  candidates     Candidate[]     // 招聘人员关联的候选人
  jobPostings    JobPosting[]    // 创建的岗位
  interviews     Interview[]     @relation("InterviewInterviewers") // 参与的面试（多对多）
  createdInterviews Interview[]  @relation("InterviewCreator") // 创建的面试
  evaluations    Evaluation[]    // 提交的评估
  interviewScores InterviewScore[] // 面试评分记录
}

// 候选人模型
model Candidate {
  id                String          @id @default(uuid())
  name              String
  email             String?         // 移除 @unique，允许为空
  phone             String?
  education         String?         @db.Text // 教育背景（文本描述）
  workExperience    String?         @db.Text // 工作经验（文本描述）
  currentPosition   String?
  currentCompany    String?
  department        String?         // 意向/所属部门
  resumeUrl         String?         // 简历文件URL（MinIO objectName）
  resumeFileName    String?         // 简历原始文件名
  resumeContent     String?         @db.Text // 简历内容（Markdown格式）
  initialScore      Float?          // 初始评分
  totalScore        Float?          // 总评分
  aiEvaluation      String?         @db.Text // AI简历评价
  aiProfile         String?         @db.Text // AI能力画像（缓存，匹配时复用）
  aiProfileUpdatedAt DateTime?               // 能力画像生成时间
  status            CandidateStatus @default(NEW)
  probationAt       DateTime?                       // 进入试用期的时间，用于招聘周期统计
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt
  recruiterId       String?         // 关联的招聘人员
  recruiter         User?           @relation(fields: [recruiterId], references: [id])
  tags              Tag[]           // 关联的标签
  certificates      Certificate[]   // 证书/技能文件
  jobMatches        JobMatch[]      // 岗位匹配记录
  interviews        Interview[]     // 面试记录
  evaluations       Evaluation[]    // 评估记录
  employeeRecord    Employee?       // 如果成为员工，关联的员工记录

  // 姓名+文件名唯一索引，用于简历去重
  @@unique([name, resumeFileName], name: "name_resumeFileName")
}

// 证书/技能文件模型
model Certificate {
  id            String    @id @default(uuid())
  candidateId   String
  candidate     Candidate @relation(fields: [candidateId], references: [id], onDelete: Cascade)
  name          String    // 证书名称
  description   String?   @db.Text // 描述
  fileUrl       String?   // MinIO 文件 URL
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

enum CandidateStatus {
  NEW              // 新建档案
  SCREENING        // 筛选中
  TALENT_POOL      // 人才池
  INTERVIEWING     // 面试中
  OFFERED          // 已发offer
  ONBOARDING       // 入职中
  PROBATION        // 试用期
  EMPLOYED         // 已正式入职
  REJECTED         // 已拒绝
  ARCHIVED         // 已归档
  RESIGNED         // 已离职
}

// 标签模型
model Tag {
  id          String      @id @default(uuid())
  name        String
  category    TagCategory // 标签类别
  createdAt   DateTime    @default(now())
  candidates  Candidate[] // 关联的候选人
  jobPostings JobPosting[] // 关联的岗位

  @@unique([name, category]) // 同一类别下名称唯一
}

enum TagCategory {
  SKILL       // 技能
  INDUSTRY    // 行业
  EDUCATION   // 教育
  EXPERIENCE  // 经验
  PERSONALITY // 性格特质
  OTHER       // 其他
}

// 岗位模型
model JobPosting {
  id              String        @id @default(uuid())
  title           String        // 职位名称
  department      String        // 部门
  description     String        @db.Text // 岗位描述
  requirements    String        @db.Text // 岗位要求
  status          JobStatus     @default(ACTIVE)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  expiresAt       DateTime?     // 岗位有效期
  creatorId       String        // 创建者ID
  creator         User          @relation(fields: [creatorId], references: [id])
  tags            Tag[]         // 岗位标签
  jobMatches        JobMatch[]       // 候选人匹配记录
  scheduledMatches  ScheduledMatch[] // 计划匹配任务
}

enum JobStatus {
  DRAFT           // 草稿
  ACTIVE          // 激活
  PAUSED          // 暂停
  FILLED          // 已招满
  EXPIRED         // 已过期
}

// 候选人-岗位匹配模型
model JobMatch {
  id            String     @id @default(uuid())
  candidateId   String
  candidate     Candidate  @relation(fields: [candidateId], references: [id])
  jobPostingId  String
  jobPosting    JobPosting @relation(fields: [jobPostingId], references: [id])
  matchScore    Float      // 匹配分数
  aiEvaluation  String?    @db.Text // AI评估内容
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt

  @@unique([candidateId, jobPostingId])
}

// 面试模型
model Interview {
  id            String           @id @default(uuid())
  candidateId   String
  candidate     Candidate        @relation(fields: [candidateId], references: [id])
  interviews    User[]           @relation("InterviewInterviewers") // 面试官（多对多）
  createdBy     User?            @relation("InterviewCreator", fields: [createdById], references: [id])
  createdById   String?
  type          InterviewType
  scheduledAt   DateTime
  location      String?          // 面试地点
  completedAt   DateTime?
  notes         String?          @db.Text // 面试记录/备注
  feedback      String?          @db.Text // 面试反馈
  decision      String?          // 面试决定
  status        InterviewStatus  @default(SCHEDULED)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
  scores        InterviewScore[] // 评分记录
}

// 面试评分模型
model InterviewScore {
  id            String    @id @default(uuid())
  interviewId   String
  interview     Interview @relation(fields: [interviewId], references: [id], onDelete: Cascade)
  interviewerId String
  interviewer   User      @relation(fields: [interviewerId], references: [id], onDelete: Cascade)
  category      String    // 评分类别
  score         Float     // 分数
  notes         String?   // 备注
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

enum InterviewType {
  PHONE         // 电话面试
  TECHNICAL     // 技术面试
  HR            // HR面试
  MANAGER       // 主管面试
  PERSONALITY   // 性格测试
}

enum InterviewStatus {
  SCHEDULED     // 已安排
  COMPLETED     // 已完成
  CANCELLED     // 已取消
  RESCHEDULED   // 已重新安排
}

// 评估模型
model Evaluation {
  id            String           @id @default(uuid())
  candidateId   String
  candidate     Candidate        @relation(fields: [candidateId], references: [id])
  evaluatorId   String
  evaluator     User             @relation(fields: [evaluatorId], references: [id])
  type          EvaluationType
  score         Float
  comments      String?          @db.Text
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt
}

enum EvaluationType {
  RESUME        // 简历评估
  INTERVIEW     // 面试评估
  PROBATION     // 试用期评估
  PERFORMANCE   // 绩效评估
}

// 员工模型（入职后）
model Employee {
  id            String     @id @default(uuid())
  candidateId   String     @unique
  candidate     Candidate  @relation(fields: [candidateId], references: [id])
  employeeId    String     @unique // 员工编号
  department    String
  position      String
  hireDate      DateTime
  probationEndDate DateTime
  status        EmployeeStatus @default(PROBATION)
  resignDate    DateTime?  // 离职日期
  resignReason  String?    // 离职原因
  currentScore  Float      // 当前评分
  projects      Project[]  // 参与的项目
  rewards       Reward[]   // 奖励记录
  penalties     Penalty[]  // 惩罚记录
  performanceReviews PerformanceReview[] // 业绩考核记录
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

enum EmployeeStatus {
  PROBATION     // 试用期
  REGULAR       // 正式员工
  RESIGNED      // 已离职
  TERMINATED    // 已解雇
}

// 项目模型
model Project {
  id            String     @id @default(uuid())
  name          String
  description   String?    @db.Text
  startDate     DateTime
  endDate       DateTime?
  status        ProjectStatus @default(ONGOING)
  employees     Employee[]
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

enum ProjectStatus {
  PLANNING      // 规划中
  ONGOING       // 进行中
  COMPLETED     // 已完成
  CANCELLED     // 已取消
}

// 奖励模型
model Reward {
  id            String     @id @default(uuid())
  employeeId    String
  employee      Employee   @relation(fields: [employeeId], references: [id])
  type          String
  description   String
  points        Float      // 加分
  date          DateTime
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

// 惩罚模型
model Penalty {
  id            String     @id @default(uuid())
  employeeId    String
  employee      Employee   @relation(fields: [employeeId], references: [id])
  type          String
  description   String
  points        Float      // 减分
  date          DateTime
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
}

// 业绩考核模型
model PerformanceReview {
  id           String   @id @default(uuid())
  employeeId   String
  employee     Employee @relation(fields: [employeeId], references: [id])
  date         DateTime               // 考核日期
  type         String                 // 考核类型：月度考核、季度考核、年度考核、试用期考核
  score        Float                  // 考核评分
  level        String?                // 考核等级：A/B/C/D/E
  summary      String   @db.Text     // 考核总结
  strengths    String?  @db.Text     // 优势/亮点
  improvements String?  @db.Text     // 待改进项
  reviewer     String                 // 考核人
  attachmentUrl String?               // 附件存储路径 (MinIO objectName)
  attachmentName String?              // 附件原始文件名
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// 计划匹配任务模型
model ScheduledMatch {
  id              String               @id @default(uuid())
  jobPostingId    String
  jobPosting      JobPosting           @relation(fields: [jobPostingId], references: [id])
  candidateIds    String[]             // 候选人ID列表
  scheduledFor    DateTime             // 计划执行时间
  status          ScheduledMatchStatus @default(PENDING)
  totalCandidates Int                  // 总候选人数
  processedCount  Int                  @default(0) // 已处理数
  error           String?              @db.Text     // 错误信息
  createdAt       DateTime             @default(now())
  updatedAt       DateTime             @updatedAt
}

enum ScheduledMatchStatus {
  PENDING    // 等待执行
  RUNNING    // 执行中
  COMPLETED  // 已完成
  FAILED     // 失败
  CANCELLED  // 已取消
}

// 计划解析任务模型
model ScheduledParse {
  id            String              @id @default(uuid())
  fileId        String
  objectName    String
  contentType   String
  originalName  String
  scheduledFor  DateTime
  status        ScheduledParseStatus @default(PENDING)
  candidateId   String?
  error         String?             @db.Text
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt
}

enum ScheduledParseStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// AI 生成任务模型（职位描述/要求生成，支持失败重试）
model AiGenTask {
  id           String      @id @default(uuid())
  title        String      // 职位名称
  department   String      // 部门
  tags         String[]    // 标签列表
  status       AiGenStatus @default(PENDING)
  description  String?     @db.Text  // 生成的岗位描述
  requirements String?     @db.Text  // 生成的岗位要求
  error        String?     @db.Text  // 失败时的错误信息
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
}

enum AiGenStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
}

// 角色菜单权限模型
model RolePermission {
  id       String @id @default(uuid())
  role     String
  menuKey  String // dashboard, candidates, interviews, jobs, matching, employees
  @@unique([role, menuKey])
}
